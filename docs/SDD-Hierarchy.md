# DEV-lldp-topomon 分層視圖與群組管理設計

## 1. 設計目標

解決 600+ 設備在前端渲染時的效能問題，同時保持所有 Access 設備的可視性。

---

## 2. 分層架構

### 2.1 三層視圖模型

```
┌─────────────────────────────────────────────────────────────────┐
│                      Layer 1: Overview                          │
│                    (Core + Distribution)                        │
│                                                                 │
│         ┌──────┐           ┌──────┐           ┌──────┐          │
│         │Core-1│═══════════│Core-2│═══════════│Core-3│          │
│         └──┬───┘           └──┬───┘           └──┬───┘          │
│            │                  │                  │              │
│        ┌───┴───┐          ┌───┴───┐          ┌───┴───┐          │
│        │Dist-1 │          │Dist-2 │          │Dist-3 │          │
│        │(5 acc)│          │(8 acc)│          │(3 acc)│          │
│        └───────┘          └───────┘          └───────┘          │
│                                                                 │
│    點擊 Dist-1 → 展開顯示其 Access 設備                          │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ 點擊展開
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Layer 2: Distribution View                    │
│                   (選中的 Dist + 其 Access)                      │
│                                                                 │
│                        ┌──────┐                                 │
│                        │Dist-1│                                 │
│                        └──┬───┘                                 │
│           ┌───────┬───────┼───────┬───────┐                     │
│           │       │       │       │       │                     │
│        ┌──┴──┐ ┌──┴──┐ ┌──┴──┐ ┌──┴──┐ ┌──┴──┐                  │
│        │Acc-1│ │Acc-2│ │Acc-3│ │Acc-4│ │Acc-5│                  │
│        └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                  │
│                                                                 │
│    可進一步展開單一 Access 詳情                                   │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ 另一種視圖
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Layer 3: Group View                         │
│                    (依群組顯示 Access)                           │
│                                                                 │
│   ┌─────────────────┐  ┌─────────────────┐  ┌────────────────┐  │
│   │   1F Office     │  │   2F Office     │  │   Server Room  │  │
│   │  ┌───┐ ┌───┐    │  │  ┌───┐ ┌───┐    │  │  ┌───┐ ┌───┐   │  │
│   │  │A-1│ │A-2│    │  │  │A-5│ │A-6│    │  │  │A-9│ │A-10│  │  │
│   │  └───┘ └───┘    │  │  └───┘ └───┘    │  │  └───┘ └───┘   │  │
│   │  ┌───┐ ┌───┐    │  │  ┌───┐          │  │  ┌───┐         │  │
│   │  │A-3│ │A-4│    │  │  │A-7│          │  │  │A-11│        │  │
│   │  └───┘ └───┘    │  │  └───┘          │  │  └───┘         │  │
│   └─────────────────┘  └─────────────────┘  └────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 群組管理

### 3.1 群組資料結構

```sql
CREATE TABLE device_groups (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    parent_id INTEGER REFERENCES device_groups(id),  -- 支援巢狀群組
    color VARCHAR(20),      -- 群組顏色標示
    icon VARCHAR(50),       -- 群組圖示
    display_order INTEGER,  -- 排序
    created_at TIMESTAMP DEFAULT NOW()
);

-- 設備與群組的多對多關係
CREATE TABLE device_group_members (
    device_id INTEGER REFERENCES devices(id) ON DELETE CASCADE,
    group_id INTEGER REFERENCES device_groups(id) ON DELETE CASCADE,
    PRIMARY KEY (device_id, group_id)
);
```

### 3.2 群組類型

| 類型 | 用途 | 範例 |
|------|------|------|
| **位置群組** | 依實體位置分類 | 1F、2F、機房 A |
| **功能群組** | 依設備用途分類 | Core、Distribution、Access |
| **自訂群組** | 用戶自行定義 | VIP 區域、維護中 |

### 3.3 群組階層範例

```
├── 總部大樓
│   ├── 1F 大廳
│   │   ├── Access-1F-01
│   │   └── Access-1F-02
│   ├── 2F 辦公區
│   │   ├── Access-2F-01
│   │   ├── Access-2F-02
│   │   └── Access-2F-03
│   └── 機房
│       ├── Core-01
│       ├── Core-02
│       └── Dist-01
├── 分公司 A
│   └── ...
└── 分公司 B
    └── ...
```

---

## 4. 前端視圖模式

### 4.1 視圖切換

```
[📊 Overview] [🏢 Group View] [🗺️ Full Map] [🔍 Search]
```

| 模式 | 說明 | 最大節點數 |
|------|------|------------|
| **Overview** | Core + Dist + 聚合的 Access 數量 | ~50 |
| **Group View** | 選中群組內的設備 | ~100 |
| **Full Map** | 全部設備（需效能優化） | 600+ |
| **Search** | 搜尋結果 + 相鄰設備 | ~20 |

### 4.2 聚合節點顯示

```
┌─────────────────────┐
│      Dist-01        │
│  ────────────────   │
│  🔗 12 Access       │  ← 顯示連接的 Access 數量
│  ⚠️ 2 Alerts        │  ← 顯示該群組的告警數
│  📊 Avg: 45%        │  ← 平均 link 使用率
└─────────────────────┘
```

### 4.3 展開操作

```javascript
// 點擊聚合節點
onNodeClick(node) {
  if (node.type === 'aggregated') {
    // 展開顯示其子設備
    expandChildren(node.id);
  } else {
    // 顯示設備詳情面板
    showDeviceDetails(node.id);
  }
}
```

---

## 5. 群組管理 UI

### 5.1 群組管理頁面

```
┌─────────────────────────────────────────────────────────────────┐
│  群組管理                                    [+ 新增群組]        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📁 總部大樓                                          [編輯][刪除]│
│    ├── 📁 1F 大廳 (4 devices)                                   │
│    ├── 📁 2F 辦公區 (12 devices)                                │
│    └── 📁 機房 (8 devices)                                      │
│                                                                 │
│  📁 分公司 A (25 devices)                             [編輯][刪除]│
│  📁 分公司 B (18 devices)                             [編輯][刪除]│
│                                                                 │
│  📁 未分類 (45 devices)                               [分配]     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 設備分配

```
┌─────────────────────────────────────────────────────────────────┐
│  分配設備到群組                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  選擇群組: [2F 辦公區 ▼]                                         │
│                                                                 │
│  可用設備:                          已分配:                      │
│  ┌──────────────────┐              ┌──────────────────┐         │
│  │ □ Access-01      │    [>>>]     │ ☑ Access-05      │         │
│  │ □ Access-02      │              │ ☑ Access-06      │         │
│  │ □ Access-03      │    [<<<]     │ ☑ Access-07      │         │
│  │ □ Access-04      │              │                  │         │
│  └──────────────────┘              └──────────────────┘         │
│                                                                 │
│  [搜尋設備: ________]                                            │
│                                                                 │
│                                      [取消] [儲存]               │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 批次分配

支援以下批次操作：
- 依 IP 範圍分配（如 10.0.1.0/24 → 1F 辦公區）
- 依命名規則分配（如 ACC-1F-* → 1F）
- 依上游設備分配（連到 Dist-01 的設備 → 機房群組）

---

## 6. API 擴充

### 新增端點

```
GET  /api/v1/groups                    # 列出群組
POST /api/v1/groups                    # 新增群組
PUT  /api/v1/groups/{id}               # 更新群組
DELETE /api/v1/groups/{id}             # 刪除群組

GET  /api/v1/groups/{id}/devices       # 群組內設備
POST /api/v1/groups/{id}/devices       # 分配設備到群組
DELETE /api/v1/groups/{id}/devices     # 從群組移除設備

POST /api/v1/groups/auto-assign        # 自動分配 (依規則)

GET  /api/v1/topology?view=overview    # Overview 視圖
GET  /api/v1/topology?view=group&id=5  # 群組視圖
GET  /api/v1/topology?expand=device_id # 展開特定設備的鄰居
```

---

## 7. 效能優化策略

| 策略 | 說明 |
|------|------|
| **預設 Overview** | 首頁只載入 Core + Dist + 聚合數據 |
| **懶加載** | 展開時才載入 Access 詳細資料 |
| **WebSocket 差量更新** | 只推送變化的數據 |
| **快取群組拓撲** | Redis 快取各群組的拓撲結構 |
| **SVG 群組化** | D3.js 用 `<g>` 元素群組化，提升渲染效率 |
