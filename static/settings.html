<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - DEV-lldp-topomon</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/theme.js"></script>
    <style>
        .settings-container {
            padding: 1.5rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .settings-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-content {
            padding: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .btn-save {
            padding: 0.5rem 1.5rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-save:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
        }

        /* Profile Card */
        .profiles-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .profile-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .profile-name {
            font-weight: 500;
        }

        .profile-default {
            padding: 0.125rem 0.5rem;
            background: rgba(88, 166, 255, 0.2);
            color: var(--accent);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .profile-thresholds {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .profile-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-icon:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Toggle Switch */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-label {
            display: flex;
            flex-direction: column;
        }

        .toggle-label span:first-child {
            font-weight: 500;
        }

        .toggle-label span:last-child {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--accent);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        /* System Info */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .info-item {
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 6px;
            text-align: center;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.125rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
        }
    </style>
</head>

<body>
    <script src="/static/js/i18n.js"></script>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üåê</span>
                <span class="logo-text">LLDP Topology Monitor</span>
            </div>
            <nav class="nav">
                <a href="/" class="nav-item" data-i18n="topology">Topology</a>
                <a href="/devices" class="nav-item" data-i18n="devices">Devices</a>
                <a href="/alerts" class="nav-item" data-i18n="alerts">Alerts</a>
                <a href="/groups" class="nav-item" data-i18n="groups">Groups</a>
                <a href="/settings" class="nav-item active" data-i18n="settings">Settings</a>
            </nav>
        </header>

        <!-- Main Content -->
        <div class="settings-container">
            <!-- Appearance Settings -->
            <div class="settings-section">
                <div class="section-header">
                    <h2>üé® <span data-i18n="appearance">Appearance</span></h2>
                </div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-i18n="language">Language</label>
                            <select id="language-select" onchange="changeLanguage(this.value)">
                                <option value="en">English</option>
                                <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                                <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-i18n="theme">Theme</label>
                            <select id="theme-select" onchange="changeTheme(this.value)">
                                <option value="dark">üåô Dark</option>
                                <option value="light">‚òÄÔ∏è Light</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Info -->
            <div class="settings-section">
                <div class="section-header">
                    <h2>üìä <span data-i18n="systemOverview">System Overview</span></h2>
                </div>
                <div class="section-content">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-value" id="info-devices">-</div>
                            <div class="info-label" data-i18n="totalDevices">Total Devices</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value" id="info-alerts">-</div>
                            <div class="info-label" data-i18n="activeAlerts">Active Alerts</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value" id="info-links">-</div>
                            <div class="info-label" data-i18n="totalLinks">Total Links</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SNMP Settings -->
            <div class="settings-section">
                <div class="section-header">
                    <h2>üîß <span data-i18n="snmpConfiguration">SNMP Configuration</span></h2>
                </div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-i18n="defaultCommunity">Default Community String</label>
                            <input type="password" id="snmp-community" placeholder="Enter community string">
                            <div class="form-help">Used for devices without specific community configured</div>
                        </div>
                        <div class="form-group">
                            <label data-i18n="pollInterval">Poll Interval (seconds)</label>
                            <input type="number" id="snmp-interval" value="60" min="30" max="300">
                            <div class="form-help">How often to poll devices (30-300s)</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-i18n="snmpTimeout">SNMP Timeout (seconds)</label>
                            <input type="number" id="snmp-timeout" value="5" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label data-i18n="snmpRetries">SNMP Retries</label>
                            <input type="number" id="snmp-retries" value="2" min="0" max="5">
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">

                    <h4 style="margin-bottom: 1rem; color: var(--text-secondary);">üîí <span
                            data-i18n="allowedSubnets">ÂÖÅË®±ÁöÑÁ∂≤ÊÆµ</span></h4>
                    <div class="form-group">
                        <label data-i18n="allowedSubnetsLabel">Êé¢Á¥¢/Ê∏¨Ë©¶ÁöÑÁõÆÊ®ô IP ÂøÖÈ†àÂú®‰ª•‰∏ãÁ∂≤ÊÆµÂÖß</label>
                        <textarea id="allowed-subnets" rows="4"
                            placeholder="192.168.0.0/16&#10;10.0.0.0/8&#10;172.16.0.0/12"
                            style="font-family: monospace; font-size: 0.875rem;"></textarea>
                        <div class="form-help" data-i18n="cidrHelpText">One CIDR per line, leave empty for no
                            restriction</div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="enforce-subnet" checked style="width: auto;">
                            <span data-i18n="enforceSubnetRestriction">Enable Subnet Restriction</span>
                        </label>
                        <div class="form-help" data-i18n="subnetRestrictionHelp">When enabled, SNMP testing and device
                            discovery only work for IPs within allowed subnets</div>
                    </div>

                    <div class="btn-row">
                        <button class="btn-save" onclick="saveSnmpSettings()" data-i18n="saveSnmpSettings">Save SNMP
                            Settings</button>
                    </div>
                </div>
            </div>

            <!-- Alert Profiles -->
            <div class="settings-section">
                <div class="section-header">
                    <h2>üö® <span data-i18n="alertProfiles">Alert Profiles</span></h2>
                    <button class="btn-secondary" onclick="openProfileModal()" data-i18n="newProfile">+ New
                        Profile</button>
                </div>
                <div class="section-content">
                    <div class="profiles-list" id="profiles-list">
                        <!-- Profiles will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Log Export -->
            <div class="settings-section">
                <div class="section-header">
                    <h2>üì§ <span data-i18n="logExport">Log Export</span></h2>
                </div>
                <div class="section-content">
                    <div class="toggle-row">
                        <div class="toggle-label">
                            <span data-i18n="enableLogExport">Enable Log Export</span>
                            <span>Send alerts and events to external systems</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="log-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label data-i18n="exportType">Export Type</label>
                        <select id="log-type">
                            <option value="elasticsearch">Elasticsearch</option>
                            <option value="graylog">Graylog (GELF)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Elasticsearch URL</label>
                        <input type="text" id="es-url" placeholder="http://localhost:9200">
                    </div>
                    <div class="btn-row">
                        <button class="btn-secondary" onclick="testLogConnection()" data-i18n="testConnection">Test
                            Connection</button>
                        <button class="btn-save" onclick="saveLogSettings()" data-i18n="save">Save</button>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="settings-section">
                <div class="section-header">
                    <h2>üîî <span data-i18n="notifications">Notifications</span></h2>
                </div>
                <div class="section-content">
                    <div class="toggle-row">
                        <div class="toggle-label">
                            <span data-i18n="browserNotifications">Browser Notifications</span>
                            <span>Show desktop notifications for new alerts</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notify-browser" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-label">
                            <span data-i18n="soundAlerts">Sound Alerts</span>
                            <span>Play sound for critical alerts</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <button class="btn-secondary" onclick="testAlertSound()"
                                style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">üîä Test</button>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notify-sound" onchange="toggleSoundAlert(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SNMP Testing Tools -->
            <div class="settings-section">
                <div class="section-header">
                    <h2>üî¨ <span data-i18n="snmpTestingTools">SNMP Ê∏¨Ë©¶Â∑•ÂÖ∑</span></h2>
                </div>
                <div class="section-content">
                    <h4 style="margin-bottom: 1rem; color: var(--text-secondary);" data-i18n="snmpConnectionTest">SNMP
                        Connection Test</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-i18n="targetIp">Target IP</label>
                            <input type="text" id="test-ip" placeholder="192.168.1.1">
                        </div>
                        <div class="form-group">
                            <label data-i18n="communityString">Community String</label>
                            <input type="text" id="test-community" placeholder="public">
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="oidOptional">OID (Optional)</label>
                        <select id="test-oid">
                            <option value="1.3.6.1.2.1.1.1.0" data-i18n="sysDescr">sysDescr - System Description
                            </option>
                            <option value="1.3.6.1.2.1.1.5.0" data-i18n="sysName">sysName - Hostname</option>
                            <option value="1.3.6.1.2.1.1.3.0" data-i18n="sysUpTime">sysUpTime - Uptime</option>
                            <option value="1.0.8802.1.1.2.1.4.1.1" data-i18n="lldpNeighbors">lldpRemTable - LLDP
                                Neighbors</option>
                            <option value="custom" data-i18n="customOidOption">Custom OID...</option>
                        </select>
                    </div>
                    <div class="form-group" id="custom-oid-group" style="display: none;">
                        <label data-i18n="customOid">Custom OID</label>
                        <input type="text" id="custom-oid" placeholder="1.3.6.1.2.1.1.1.0">
                    </div>
                    <div class="btn-row" style="border-top: none; padding-top: 0;">
                        <button class="btn-secondary" onclick="testSnmpWalk()" id="btn-snmpwalk">üîç SNMP Walk</button>
                        <button class="btn-save" onclick="testSnmpGet()" id="btn-snmpget">üì° SNMP Get</button>
                    </div>
                    <div id="snmp-result" style="display: none; margin-top: 1rem;">
                        <label style="color: var(--text-secondary); font-size: 0.875rem;" data-i18n="testResult">Test
                            Result</label>
                        <pre id="snmp-result-content"
                            style="background: var(--bg-primary); padding: 1rem; border-radius: 6px; overflow-x: auto; max-height: 200px; font-size: 0.75rem; color: var(--text-primary); margin-top: 0.5rem;"></pre>
                    </div>

                    <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">

                    <h4 style="margin-bottom: 1rem; color: var(--text-secondary);" data-i18n="manualDiscovery">Manual
                        Device Discovery</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-i18n="discoveryIp">IP Address</label>
                            <input type="text" id="discover-ip" placeholder="192.168.1.1">
                        </div>
                        <div class="form-group">
                            <label data-i18n="discoveryCommunity">Community String</label>
                            <input type="text" id="discover-community" placeholder="public">
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="discover-recursive" checked style="width: auto;">
                            <span data-i18n="recursiveDiscovery">Recursive Discovery (Discover LLDP Neighbors)</span>
                        </label>
                        <div class="form-help" data-i18n="recursiveDiscoveryHelp">When enabled, automatically discovers
                            all neighbors of discovered devices</div>
                    </div>
                    <div class="btn-row" style="border-top: none; padding-top: 0;">
                        <button class="btn-save" onclick="manualDiscover()" id="btn-discover">üîé <span
                                data-i18n="startDiscovery">Start Discovery</span></button>
                    </div>
                    <div id="discover-result" style="display: none; margin-top: 1rem;">
                        <label style="color: var(--text-secondary); font-size: 0.875rem;"
                            data-i18n="discoveryResult">Discovery Result</label>
                        <div id="discover-result-content"
                            style="background: var(--bg-primary); padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div class="modal-overlay" id="profile-modal" style="display: none;">
            <div class="modal" style="width: 450px;">
                <div class="modal-header">
                    <h3 id="profile-modal-title">New Alert Profile</h3>
                    <button class="modal-close" onclick="closeProfileModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Profile Name</label>
                        <input type="text" id="profile-name" placeholder="e.g. High Performance">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="profile-desc" placeholder="Optional description">
                    </div>
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">CPU Thresholds
                        (%)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Warning</label>
                            <input type="number" id="cpu-warning" value="80" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label>Critical</label>
                            <input type="number" id="cpu-critical" value="95" min="1" max="100">
                        </div>
                    </div>
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Memory
                        Thresholds (%)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Warning</label>
                            <input type="number" id="mem-warning" value="85" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label>Critical</label>
                            <input type="number" id="mem-critical" value="95" min="1" max="100">
                        </div>
                    </div>
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Link
                        Utilization Thresholds (%)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Warning</label>
                            <input type="number" id="link-warning" value="70" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label>Critical</label>
                            <input type="number" id="link-critical" value="90" min="1" max="100">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeProfileModal()">Cancel</button>
                    <button class="btn-save" onclick="saveProfile()">Save Profile</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let profiles = [];
        let editingProfileId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadSystemInfo();
            loadProfiles();
        });

        async function loadSystemInfo() {
            try {
                const [devicesRes, alertsRes] = await Promise.all([
                    fetch(`${API_BASE}/devices?limit=1`),
                    fetch(`${API_BASE}/alerts/active`)
                ]);

                const devicesData = await devicesRes.json();
                const alertsData = await alertsRes.json();

                document.getElementById('info-devices').textContent = devicesData.total || 0;
                document.getElementById('info-alerts').textContent = alertsData.total || alertsData.alerts?.length || 0;
                document.getElementById('info-links').textContent = '-'; // Would need topology API
            } catch (error) {
                console.error('Error loading system info:', error);
            }
        }

        async function loadProfiles() {
            try {
                const response = await fetch(`${API_BASE}/profiles`);
                profiles = await response.json();
                renderProfiles();
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        function renderProfiles() {
            const container = document.getElementById('profiles-list');

            if (profiles.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No custom profiles. Using system defaults.</p>';
                return;
            }

            container.innerHTML = profiles.map(p => `
                <div class="profile-card">
                    <div class="profile-info">
                        <span class="profile-name">${p.name}</span>
                        ${p.is_default ? '<span class="profile-default">DEFAULT</span>' : ''}
                        <span class="profile-thresholds">
                            CPU: ${p.thresholds?.cpu?.warning || 80}/${p.thresholds?.cpu?.critical || 95}% | 
                            MEM: ${p.thresholds?.memory?.warning || 85}/${p.thresholds?.memory?.critical || 95}%
                        </span>
                    </div>
                    <div class="profile-actions">
                        <button class="btn-icon" onclick="editProfile(${p.id})">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteProfile(${p.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function openProfileModal(profileId = null) {
            editingProfileId = profileId;
            const modal = document.getElementById('profile-modal');
            const title = document.getElementById('profile-modal-title');

            if (profileId) {
                const profile = profiles.find(p => p.id === profileId);
                title.textContent = 'Edit Profile';
                document.getElementById('profile-name').value = profile?.name || '';
                document.getElementById('profile-desc').value = profile?.description || '';
                document.getElementById('cpu-warning').value = profile?.thresholds?.cpu?.warning || 80;
                document.getElementById('cpu-critical').value = profile?.thresholds?.cpu?.critical || 95;
                document.getElementById('mem-warning').value = profile?.thresholds?.memory?.warning || 85;
                document.getElementById('mem-critical').value = profile?.thresholds?.memory?.critical || 95;
                document.getElementById('link-warning').value = profile?.thresholds?.link_utilization?.warning || 70;
                document.getElementById('link-critical').value = profile?.thresholds?.link_utilization?.critical || 90;
            } else {
                title.textContent = 'New Alert Profile';
                document.getElementById('profile-name').value = '';
                document.getElementById('profile-desc').value = '';
                document.getElementById('cpu-warning').value = 80;
                document.getElementById('cpu-critical').value = 95;
                document.getElementById('mem-warning').value = 85;
                document.getElementById('mem-critical').value = 95;
                document.getElementById('link-warning').value = 70;
                document.getElementById('link-critical').value = 90;
            }

            modal.style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
            editingProfileId = null;
        }

        function editProfile(profileId) {
            openProfileModal(profileId);
        }

        async function saveProfile() {
            const data = {
                name: document.getElementById('profile-name').value,
                description: document.getElementById('profile-desc').value,
                thresholds: {
                    cpu: {
                        warning: parseInt(document.getElementById('cpu-warning').value),
                        critical: parseInt(document.getElementById('cpu-critical').value),
                        recovery_buffer: 10
                    },
                    memory: {
                        warning: parseInt(document.getElementById('mem-warning').value),
                        critical: parseInt(document.getElementById('mem-critical').value),
                        recovery_buffer: 10
                    },
                    link_utilization: {
                        warning: parseInt(document.getElementById('link-warning').value),
                        critical: parseInt(document.getElementById('link-critical').value),
                        recovery_buffer: 10
                    }
                }
            };

            if (!data.name) {
                alert('Profile name is required');
                return;
            }

            try {
                const url = editingProfileId
                    ? `${API_BASE}/profiles/${editingProfileId}`
                    : `${API_BASE}/profiles`;
                const method = editingProfileId ? 'PUT' : 'POST';

                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                closeProfileModal();
                loadProfiles();
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile');
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('Delete this profile?')) return;

            try {
                await fetch(`${API_BASE}/profiles/${profileId}`, { method: 'DELETE' });
                loadProfiles();
            } catch (error) {
                console.error('Error deleting profile:', error);
            }
        }

        // ===== Sound Alert Functions =====
        function testAlertSound() {
            if (window.AlertSound) {
                AlertSound.playTest();
            } else {
                // Fallback: load sound.js dynamically
                const script = document.createElement('script');
                script.src = '/static/js/sound.js';
                script.onload = function () {
                    AlertSound.playTest();
                };
                document.head.appendChild(script);
            }
        }

        function toggleSoundAlert(enabled) {
            localStorage.setItem('notify_sound', enabled ? 'true' : 'false');
            if (window.AlertSound) {
                AlertSound.setEnabled(enabled);
            }
        }

        function loadSoundSettings() {
            const enabled = localStorage.getItem('notify_sound') === 'true';
            document.getElementById('notify-sound').checked = enabled;
        }

        function saveSnmpSettings() {
            // Save subnet settings to localStorage
            const subnets = document.getElementById('allowed-subnets').value;
            const enforceSubnet = document.getElementById('enforce-subnet').checked;
            localStorage.setItem('snmp_allowed_subnets', subnets);
            localStorage.setItem('snmp_enforce_subnet', enforceSubnet);
            alert(i18n.t('settingsSaved'));
        }

        function loadSnmpSettings() {
            const subnets = localStorage.getItem('snmp_allowed_subnets') || '';
            const enforceSubnet = localStorage.getItem('snmp_enforce_subnet') !== 'false';
            document.getElementById('allowed-subnets').value = subnets;
            document.getElementById('enforce-subnet').checked = enforceSubnet;
        }

        // ===== Language and Theme =====
        function changeLanguage(lang) {
            if (window.i18n) {
                i18n.setLanguage(lang);
            }
        }

        function changeTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        function loadAppearanceSettings() {
            // Language
            const savedLang = localStorage.getItem('language') || 'en';
            document.getElementById('language-select').value = savedLang;

            // Theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.getElementById('theme-select').value = savedTheme;
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSnmpSettings();
            loadAppearanceSettings();
            loadSoundSettings();
        });

        function saveLogSettings() {
            // Would save to backend
            alert('Log export settings saved (demo)');
        }

        function testLogConnection() {
            // Would test connection
            alert('Connection test: Success (demo)');
        }

        // ===== Subnet Validation =====
        function ipToLong(ip) {
            const parts = ip.split('.').map(Number);
            return (parts[0] << 24) + (parts[1] << 16) + (parts[2] << 8) + parts[3];
        }

        function isIpInCidr(ip, cidr) {
            const [network, bits] = cidr.split('/');
            const mask = -1 << (32 - parseInt(bits));
            const ipLong = ipToLong(ip);
            const networkLong = ipToLong(network);
            return (ipLong & mask) === (networkLong & mask);
        }

        function isIpAllowed(ip) {
            const enforceSubnet = document.getElementById('enforce-subnet').checked;
            if (!enforceSubnet) return true;

            const subnetsText = document.getElementById('allowed-subnets').value.trim();
            if (!subnetsText) return true; // Empty means no restriction

            const subnets = subnetsText.split('\n').map(s => s.trim()).filter(s => s && s.includes('/'));
            if (subnets.length === 0) return true;

            for (const subnet of subnets) {
                if (isIpInCidr(ip, subnet)) {
                    return true;
                }
            }
            return false;
        }

        function validateIpBeforeAction(ip) {
            if (!isIpAllowed(ip)) {
                const subnets = document.getElementById('allowed-subnets').value.trim().split('\n').filter(s => s.trim()).join(', ');
                alert(i18n.t('ipNotInSubnets').replace('{ip}', ip).replace('{subnets}', subnets || i18n.t('notConfigured')));
                return false;
            }
            return true;
        }

        // SNMP Testing Tools
        document.getElementById('test-oid').addEventListener('change', function () {
            document.getElementById('custom-oid-group').style.display =
                this.value === 'custom' ? 'block' : 'none';
        });

        async function testSnmpGet() {
            const ip = document.getElementById('test-ip').value.trim();
            const community = document.getElementById('test-community').value.trim() || 'public';
            const oidSelect = document.getElementById('test-oid').value;
            const oid = oidSelect === 'custom'
                ? document.getElementById('custom-oid').value.trim()
                : oidSelect;

            if (!ip) {
                alert(i18n.t('enterTargetIp'));
                return;
            }

            if (!validateIpBeforeAction(ip)) {
                return;
            }

            const btn = document.getElementById('btn-snmpget');
            btn.disabled = true;
            btn.textContent = i18n.t('testing');

            try {
                const response = await fetch(`${API_BASE}/snmp/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, community, oid, method: 'get' })
                });
                const data = await response.json();

                document.getElementById('snmp-result').style.display = 'block';
                const resultEl = document.getElementById('snmp-result-content');

                if (data.success) {
                    resultEl.style.color = 'var(--success)';
                    resultEl.textContent = `‚úÖ ÊàêÂäü\n\nOID: ${oid}\nÁµêÊûú: ${data.result}`;
                } else {
                    resultEl.style.color = 'var(--danger)';
                    resultEl.textContent = `‚ùå Â§±Êïó\n\nÈåØË™§: ${data.error}`;
                }
            } catch (error) {
                document.getElementById('snmp-result').style.display = 'block';
                const resultEl = document.getElementById('snmp-result-content');
                resultEl.style.color = 'var(--danger)';
                resultEl.textContent = `‚ùå Ë´ãÊ±ÇÂ§±Êïó: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì° SNMP Get';
            }
        }

        async function testSnmpWalk() {
            const ip = document.getElementById('test-ip').value.trim();
            const community = document.getElementById('test-community').value.trim() || 'public';
            const oidSelect = document.getElementById('test-oid').value;
            const oid = oidSelect === 'custom'
                ? document.getElementById('custom-oid').value.trim()
                : oidSelect;

            if (!ip) {
                alert(i18n.t('enterTargetIp'));
                return;
            }

            if (!validateIpBeforeAction(ip)) {
                return;
            }

            const btn = document.getElementById('btn-snmpwalk');
            btn.disabled = true;
            btn.textContent = i18n.t('testing');

            try {
                const response = await fetch(`${API_BASE}/snmp/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, community, oid, method: 'walk' })
                });
                const data = await response.json();

                document.getElementById('snmp-result').style.display = 'block';
                const resultEl = document.getElementById('snmp-result-content');

                if (data.success) {
                    resultEl.style.color = 'var(--success)';
                    const results = Array.isArray(data.result)
                        ? data.result.map(r => `${r.oid}: ${r.value}`).join('\n')
                        : data.result;
                    resultEl.textContent = `‚úÖ SNMP Walk ÊàêÂäü (${data.count || 0} Á≠ÜÁµêÊûú)\n\n${results}`;
                } else {
                    resultEl.style.color = 'var(--danger)';
                    resultEl.textContent = `‚ùå Â§±Êïó\n\nÈåØË™§: ${data.error}`;
                }
            } catch (error) {
                document.getElementById('snmp-result').style.display = 'block';
                const resultEl = document.getElementById('snmp-result-content');
                resultEl.style.color = 'var(--danger)';
                resultEl.textContent = `‚ùå Ë´ãÊ±ÇÂ§±Êïó: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç SNMP Walk';
            }
        }

        async function manualDiscover() {
            const ip = document.getElementById('discover-ip').value.trim();
            const community = document.getElementById('discover-community').value.trim() || 'public';
            const recursive = document.getElementById('discover-recursive').checked;

            if (!ip) {
                alert(i18n.t('enterStartIp'));
                return;
            }

            if (!validateIpBeforeAction(ip)) {
                return;
            }

            const btn = document.getElementById('btn-discover');
            btn.disabled = true;
            btn.textContent = i18n.t('discovering');

            try {
                const response = await fetch(`${API_BASE}/discovery/manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, community, recursive })
                });
                const data = await response.json();

                document.getElementById('discover-result').style.display = 'block';
                const resultEl = document.getElementById('discover-result-content');

                if (data.success) {
                    let html = `<div style="color: var(--success); margin-bottom: 0.5rem;">‚úÖ ${i18n.t('discoveryComplete')}</div>`;
                    html += `<div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">${i18n.t('discoveredDevices').replace('{count}', data.discovered_count || 0).replace('{added}', data.added_count || 0)}</div>`;

                    if (data.devices && data.devices.length > 0) {
                        html += `<div style="display: flex; flex-direction: column; gap: 0.5rem;">`;
                        data.devices.forEach(d => {
                            const statusColor = d.is_new ? 'var(--success)' : 'var(--text-secondary)';
                            html += `
                                <div style="background: var(--bg-secondary); padding: 0.5rem 0.75rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 500;">${d.hostname || d.ip}</span>
                                    <span style="font-size: 0.75rem; color: ${statusColor};">${d.is_new ? i18n.t('newDevice') : i18n.t('alreadyExists')}</span>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    resultEl.innerHTML = html;
                } else {
                    resultEl.innerHTML = `<div style="color: var(--danger);">‚ùå ${i18n.t('discoveryFailed')}: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('discover-result').style.display = 'block';
                const resultEl = document.getElementById('discover-result-content');
                resultEl.innerHTML = `<div style="color: var(--danger);">‚ùå ${i18n.t('discoveryFailed')}: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `üîé <span data-i18n="startDiscovery">${i18n.t('startDiscovery')}</span>`;
            }
        }

        // Initialize i18n
        if (window.i18n) {
            i18n.init();
        }
    </script>
</body>

</html>